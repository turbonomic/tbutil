changequote([[,]])dnl
changecom(////)dnl
# TButil (VERSION) - Example scripts

*Last updated: DATE*

---

Tbutil is delivered with a set of example scripts that are provided for educational purposes and could provide the foundation for more polished customer scripts. This document will be expanded over time to list and describe the available examples.

Please note: these scripts were originally written for "Classic" version of Turbonomic and may not work with XL. Please refer to the notes below to determine whether the scipt has been tested and works with XL or not. You should take an absense of a comment to indicate that the script is untested. If you have a particular script you are interested having tested or fixed for XL, please let me know (chris.lowth@turbonomic.com).


## Documentation scripts

### list-vars.js

(Works with all classic and XL versions)

This lists all the variables and functions known to tbscript.

Run using: tbscript list-vars.js

## Formatter Scripts

(Works with all classic and XL versions)

Formatter scripts perform no API actions themselves but are used to process the output of APIs executed by tbutil sub commands. They are called using the "-s" output option supported by many sub commands, and their job is to turn the contents of the "tree" array or object into a human-readable format.

### actions-by-type.js

(Works with all classic and XL versions)

Formats the output of the "list actions" sub-command to show the number of actions by type and severity. The output is presented as a small JSON document.

Run using: `tbutil list actions -s actions-by-type.js Market`

### count.js

(Works with all classic and XL versions)

The simplest all formatter scripts. It just prints the number of entries in the array generated by the sub command.

Run using: `tbutil {sub-command} -s count.js |`

### customer-summary.js

### export-dynamic-groups.js

(Works with all classic and XL versions)

Formats the output of "list my groups" to show the filters used for all the configured dynamic user groups.

Run using: `tbutil list my groups -s export-dynamic-groups.js`

### groups-csv.js

Formats the output of the "list groups" sub command as CSV.

Run using: `tbutil list groups -s groups-csv.js`

### severity-count.js

Run using: `tbutil list actions -s severity-count.js Market`

### vm-move-actions-for-host.js	

Prints the pending VM move actions associated with a specified host. The output is presented as a text table with columns that show the direction ("Arriving" or "Leaving"), the VM type and name, the reason for the move and the action severity.

Run using: `tbutil list actions -s vm-move-actions-for-host.js {host_uuid}`


## REST API Scripts

REST API scripts are run using "tbscript" or "tbutil -s" and perform REST API calls directly. They can potentially make multiple API calls, and can even run APIs against multiple Turbonomic instances (optionally; in parallel).


### actions-to-arangodb.js

Reads all the actions in the current market and stores them in the "actions" collection of an ArangoDB instance - this allows use AQL to query the actions thus listed.

You can use the "start-arango-container.sh" to start a compatible ArangoDB server.

Run using: `tbscript actions-to-arangodb.js`


### azure-vms.js

Lists Azure VMs, showing their names, costs per hour, template, region and status.

Run using: `tbscript azure-vms.js`


### cluster-counts.js

Count the number of various entity types in all clusters.

Can be run against multiple instances in parallel.

```
Usage is:

  tbscript [{cred}] cluster-counts.js [-x {file}] [-C {file}] [-A]

Where:
  -x    Set the name of the file to write to. Must have an extension of .csv, .xlsx, .txt or .html
  -A    Query all the instances whose credentials are stored in the .tbutilrc file.
  -C    Name or path of Turbonomic instance credentials list file

Notes:
       Options -A and -C are mutually exclusive (you cant specify both).

       If either -A or -C are specified then the '{cred}' argument will be ignored.

       The -C file must be a text file containing a list of credential specs, one per line. These
       can be in any of the formats supported by tbutil. Eg: '@london', or: 'user:pass@host' - etc.
       Lines starting with a '#' are treated as comments, and so are ignored.
```

### cluster-summary.js


Reports the summary stats for a named cluster in a format that mirrors that shown in the HTML/5 front end to vCenter. The values reported are the values from the most recent poll.

Typical output looks like..

```
Counter     Value
----------  -----
VMs           345
Hosts          23
Datastores      3

Commodity     Capacity  Used    %Used  Free  
------------  --------  ------  -----  ------
CPU (GHz)       814.84  225.34  27.65  589.50
Mem (TB)          4.00    2.13  53.34    1.87
Storage (TB)     21.00   14.37  68.42    6.63
```

Run using: `tbscript cluster-summary.js {cluster-name}`


### cluster-utilization.js

Reports on the memory and cpu usage of the clusters. It mirrors the output of the "top cluster utilization" widget but has the additional feature that it can collect from multiple Turbnomic instances in parallel, and combine the results into a single table,

Usage is..

```
Usage is:

	tbscript [{creds}] cluster-utilization.js [-l|-j|-y|-x {file}|-s {script}] [-credentials-file {file}] [-columns {list}] [-order-by {list}]

Where:
	-l  output "long" text table format
	-j  output JSON format
	-y  output YAML format
	-x  output to xlsx, csv, html or txt file (depends on extension)
	-s  execute named script to process results
	-credentials-file:  collect stats from all instances listed in file.
	-order-by:          choose the columns to sort by (see notes).
	-columns:           choose the columns to output.
```

Column numbers used by the "-order-by" and "-columns" options are integer numbers starting at zero. "-order-by" column numbers are applied first, and the "-columns" numbers are used to reduce the output. This means you can filter by a column that you dont even output. You can use negative numbers on the order-by list to reverse the order of the sort.

Example:

```
tbscript @test cluster-utilization.js -order-by "2,-11" -columns "1,2,3,4"
```

This sorts by severity (column 2) then by memory utilization (column 11 - highest values first) the outputs cluster name and the counts of entities.


### cores-by-cluster.js

Gives the number of cores for each ONPREM cluster. The output shows the cluster UUID, name, target type and number of cores.

```
Usage:

   tbscript [@creds] coresByCluster.js -l|-j|-y|-s {script}|-x {file} [-columns ..]

Options:

  -columns: list of column numbers to show (comma delimited, starting at 0)
  -j      : output to stdout in JSON format
  -l      : output long summary format to stdout
  -s      : output to stdout using the specified JS script
  -x      : output to the specified xlsx, csv, lst, txt or html file
  -y      : output to stdout in YAML formatML format
```

### cores-by-host.js

Gives the number of cores for each ONPREM host. The output shows the Host name, target type, uuid and number of cores.

Run using: `tbscript cores-by-host.js`


### create-local-user.js

Creates a local Turbo user called "peter_pan". This is for demo purposes only but can be used as the foundation for more complete scripts.

### find.js

### findEntities.js

Given an entity class as argument, this script prints the UUID and name of entities of that class. Example valid classes include "VirtualMachine", "PhysicalMachine", "Group", "Cluster" - etc.

Run using: `tbscript findEntities.js {class-name}`

### group-tree.js

### list-groups.js

### list-ris.js

### list-vm-aspects.js

### multi-threaded.js

### pending-vm-rightsizes.js

(This is the classic verion. For XL, please use xl-pending-vm-rightsizes.js).

Lists the pending rightsize actions for OMPREM VMs by cluster. The output is an Excel workbook with one "tab" per cluster.

The columns are..
- VM (display name).
- OS
- Commodity (VMem or VCPU).
- Change (UP or DOWN)
- From value
- To value

Run using: `tbscript [{cred}] pending-vm-rightsizes.js {output-excel-file-name.xlsx}`

### reclamation.js

### reset-turbo.js

### run-plan-per-cluster.js

Example showing how bulk plans can be configured and run.

See RUNNING-PLANS.pdf for more details.

### tabulate-groups.js

A quick demo of the "tabulate" library function, which provides an alternative approach to creating text tables from API returns. The listing is presented as a JSON array.

Run using: `tbscript tabulate-groups.js`

### vm-capacity-and-usage.js

Mirrors the output of the "Capacity and Usage" widget from the UI. For the VM who's UUID is supplied, it presents a list of the commodities consumed and provided, showing the capacity and usage.

Run using: `tbscript vm-capacity-and-usage.js {vm_uuid}`

### vm-cluster.js

Displays the name of the cluster to which the VM who's UUID is specified relates.

Run using: `tbscript vm-cluster.js {vm_uuid}`

### vms-by-cluster.js

Prints a table showing the VMs and the cluster to which each belongs. The output format options are..

- -t: print a text table
- -c: print CSV
- -x {filename}: create an output sheet file (eg: excel)

Run using: `tbscript vms-by-cluster.js {output_format_option}`

### vm-peaks.js

Documentation to follow


### vms-by-cluster-2.js

A much enhanced version of the above.

It reads the VMs per cluster for a number of Turbo instances and creates an Excel spreadsheet where each instance's data is stored in a different tab.

The columns in each tab are...

- UUUID
- Cluster name
- VM Name
- Num VCPUs
- Provisioned memory size in MB.
- Operating system
- Internal ID (as known to VMWare - etc).
- State
- IP Address(s)

Run using: `tbscript [creds] vms-by-cluster-2.js [-x {excel_file_name}] [-u] [-i] [-C {creds_file_name}]`

Where...
- -C: Name of file containing credentials (one per line) for multiple instances.
- -u: Include VMs UUIDS in the output.
- -i: Include the VM ID in the output.
- -x: Write output to an EXCEL workbook.

### vms-by-group-type-detail.js

### vms-by-group-type-summary.js

### kpi/action-kpis.js

Reports a collection of action KPI values, such as VMs on congested hosts - etc.

Run using: `tbscript kpi/action-kpis.js`

### kpi/automation-stats.js

Prints a report on the degree of action automation configured per action type per cluster. The output can be written to excel too.

To get a help usage, run: `tbscript kpi/automation-stats.js`

### kpi/cluster-risks.js

Creates a sqLite database called "risks.db" which contains a table "risk". Each row contains the number of risks of each severity per cluster. The script appends new records to the table each time it's run - meaning that if "cron" it to run daily, we can begin to gather historical data for analysis.

Run using: `tbscript kpi/cluster-risks.js`

### kpi/cluster-settings.js

Displays the level of automation for all known clusters. Can be run against multiple instances in parallel, if desired.

Example output: (lab instance with no automation)..	

```
Cluster                                        Num VMs  Move%  StorageMove%  CpuUp%  CpuDown%  MemUp%  MemDown%
---------------------------------------------  -------  -----  ------------  ------  --------  ------  --------
RedHatDC-NFS\RedHatDC-NFS\RedHatCluster-NFS          2      0             0       0         0       0         0
VMM-DC-vmm2016.corp.vmturbo.com\hv16-cluster2       10      0             0       0         0       0         0
Datacenter-dc9\DC9-Cluster1                         21      0             0       0         0       0         0
VMM-DC-vmm2016.corp.vmturbo.com\hv16-cluster1       38      0             0       0         0       0         0
Development DC7\Cluster1                            81      0             0       0         0       0         0
HawthorneSales\Turbonomic SE Lab                   309      0             0       0         0       0         0
```

Usage:

```
  tbscript [{cred}] cluster-settings.js [-C {credentials_list_file}] [-l|-x {table_file}] [-u] [-a] [-m {type}]
or:
  cluster-settings.js [-c {cred}] [-C {credentials_list_file}] [-l|-x {table_file}] [-u] [-a] [-m {type}]

-l   Print listing on stdout.
-x   Write to the specified table file (can be .txt, .csv, .xlsx or .html)
-u   Include cluster UUIDs in the output.
-C   Visit the Turbonomic instances who's credentials are given in the named text file.
-a   Visit all Turbonomic instances defined in the .tbutilrc file.
-m   Select the level of automation to be reported on (AUTOMATIC, MANUAL, RECOMMEND or DISABLED)
-v   Verbose"

Notes:
 * One of -l or -x must be specified.
 * -a and -C both override the {cred} parameter, if specified.
 * -a and -C are mutually exclusive.
 * -v cannot be used with -C or -a.
 * -u cannot be used without -x.
```

### kpi/cluster-supplychains.js

Prints a table of the number of critical and major VMs, PMs and Storages per cluster. The data is extracted using the supplychain API.

Run using: `tbscript kpi/cluster-supplychains.js`

### kpi/headroom.js

### kpi/headroom2.js

Prints headroom metrics for all clusters or the clusters in a specified group.

This script outputs a summary of headroom info for the clusters in the instance. For each cluster, it reports:
- cluster name
- headroom (min of cpu, vmem and storage headeroom figures)
- VM template used for headroom calcs
- template vCPU count
- template vMem size
- CPU, memory and storage headroom capacity (number of template VMs)

Example output...

```
Cluster                                            Headroom  VM Template                                                                 vCPUs  vMem     CPU HdRm  Mem HdRm  rage HdRm
-------------------------------------------------  --------  --------------------------------------------------------------------------  -----  -------  --------  --------  ---------
HawthorneSales\Turbonomic SE Lab                          0  AVG:PMs_HawthorneSales\Turbonomic SE Lab for last 10 days                       3  9430 MB         0                    0
RedHatDC-iSCSI\RedHatDC-iSCSI\RedHatCluster-iSCSI         0  AVG:PMs_RedHatDC-iSCSI\RedHatDC-iSCSI\RedHatCluster-iSCSI for last 10 days      2   416 MB        33                    -
RedHatDC-NFS\RedHatDC-NFS\RedHatCluster-NFS               0  Microsoft_SQL2008-medium                                                        2  2048 MB        79       340          -
```

Usage is:

```
    tbscript [{cred}] headroom2.js [-l|-x {output-file}] [-group {group-uuid}] [-sum] [-columns {list}]
```

Where:

```
-l
    Output text table (default)

-x {output-file}
    Write the output to the specified file, which can have an extension of ".xlsx",
    ".csv", ".txt" or ".html"

-group {group-uuid}
    Present headroom stats only for the clusters that are members of the group who's
    uuid is supplied. Without this option, all clusters known to Turbonomic are
    used. Group UUIDs can be determined using the command "tbutil list groups -l".

-sum
    Present the total headroom figures for all the selected clusters. Without this
    option, a line is output for each cluster. With this option, a single line
    is output containing the summed.

-columns {list}
    The list of column numbers (starting at 0) to output. The list is a list of integer
    numbers delimited by commas. All columns are output if the option is not used.
```

Note: if used, the -l or -x option must be the FIRST option specified.

### kpi/market-supplychain.js

Show the number of entities of each type in the Market and shows how many are active, idle, minor, major etc. Output can be in text table, json, yaml or csv format.

Run using: `tbscript kpi/market-supplychain.js [-l|-j|-k|-c]`

### kpi/vcpus-per-cpu.js

### kpi/vms-on-mem-congested-hosts.js


## API V1 Scripts

API V1 scripts make use of the "apiv1-plugin" to access data from Turbonomic using the old API. These calls are much lower level than the REST equivalents but can expose a greater level of detail (and hence, by implication) can involve larger payloads.

### commodities.js


### v1getc.js

(Will NOT work with XL - the V1 API has been discontinued).

Lists the object classes known the the V1 API.

Run using: `tbscript v1getc.js`


### v1geti.js

(Will NOT work with XL - the V1 API has been discontinued).

Lists the object instances that are members of a specified class, using the V1 API.

Run using: `tbscript v1geti.js {class_name}`


### v1get.js

(Will NOT work with XL - the V1 API has been discontinued).

Prints the full structure associated with an object instance specified by its UUID. The output is presented in JSON format.

Run using: `tbscript v1get.js {instance_uuid}`


### xl-pending-vm-rightsizes.js

(This is the XL version. For classic, please use pending-vm-rightsizes.js)

Tested with Turbonomic 8.0.4.

Lists the pending rightsize actions for OMPREM VMs by cluster. The output is an Excel workbook with one "tab" per cluster.

The columns are..
- VM (display name).
- OS
- Commodity (VMem or VCPU).
- Change (UP or DOWN)
- From value
- To value

Run using: `tbscript [{cred}] pending-vm-rightsizes.js {output-excel-file-name.xlsx}`


## MySQL/JS Scripts

Scripts of this type are written in JS, but work by making MySQL queries and processing the results. Some of these scripts combine historic data pulled from MySQL with live data pulled from the API. These scripts make use of the "mysql-plugin".

### collect-actions.js

(Classic only - does not work with XL).


### create-group-from-sql-query.js

(Classic only - does not work with XL).


### failed-moves.js

(Classic only - does not work with XL).

Creates a list (excel, by default) of the failed attempts to move VMs in the last 7 (by default) days. Data is taken from the audit_log_entries table.

```
Usage is:

	tbscript [{cred}] failed-moves.js [-l|-x {output-file-name}] [-db {local-mysql-db-spec}] [-today {yyyy-mm-dd}] [-days {n}]

Where:
	-l
		produce listing on stdout ('details' column is clipped to max 40 chars)

	-x {output-file-name}:
		name of a file with a .xlsx, .csv, .html or .txt extension. The default is
  		"failed-moves-YYYY-MM-DD.xlsx" (where YYYY-MM-DD is todays date) if neither
  		-x nor -l are specified.

	-db {local-mysql-db-spec}:
		the MySQL database key, used when accessing a local DB (don't use this when
		accessing a live Turbonomic instance)

	-today {yyyy-mm-dd}:
		specify the date to use as 'today'. Default is today's date as known to the DB.

	-days {n}:
		the number of days back to check. Default is 7
```

### idle-vms.js

(Classic only - does not work with XL).

Use "tbutil list idle vms -l" instead of this script.


### members-to-mysql.js

(Classic only - does not work with XL).


### num-vcpus-per-vm.js

(Classic only - does not work with XL).

Display the number of VCPUs per VM.

Usage is:

```
tbscript [{creds}] num-vcpus-per-vm.js [-u {scope_uuid}] [-m {max}] [-U] [-C]

Where:
	-u: limit scope to the group/cluster/market who's uuid or internal name is given.
	-m: limit output to VMs with this number of VCPUs or more.
	-U: include VM uuids in the output.
	-C: include cluster names in the output.
```

### pm-stats.js

(Classic only - does not work with XL).

Displays the range of VMs counts per host over the time period stored in the daily-stats MySQL table.

Run using: `tbscript pm-stats.js`

### rightsize-actions-log.js

(Classic only - does not work with XL).

Lists the VMem and VCPU right-sizing actions that have been executed or failed over a specified time period.

```
Usage is:

  tbscript [{creds}] rightsize-actions-log.js [{options}]

  Where options are..

      -x {filename}.xlsx
              Specify the name of the output excel spreadsheet file (mandatory)

      -start {yyyy-mm-dd}  -end {yyyy-mm-dd}
              Specify the start and end dates (default for end is today, default for start is
              14 days ago).

      -days {n}
              Specify the number of days back (default is 14).
              Note: either use -start/-end or -days; not both.

      -mode both|failed|completed
              Whether to include completed actions, failed actions or both.

      -credfile {filename}
              The file name to read Turbonomic instance credental list from (one instance per line).
```

### store-settings.js


### top-ready-queue-vms.js

(Classic only - does not work with XL).

Collects and presents information about the VMs with top ready-queue utilization.

The usage is..

```
tbscript top-ready-queue-vms.js [-x {outputFile}] [-columns {list}] [-ndays {nDays}] [-nvms {nVms}] {cluster_1_name} {cluster_2_name} ..

Where:
	-x      : set the output file name
	-columns: select the output column numbers (first=0)
	-ndays  : set the number of day's data to inspect (default = 30).
	-nvms   : set the number of VMs to list (default = 20)

If you supply a single cluster name of "Market", the report looks at ALL VMs known to Turbonomic.

```


## Pure MySQL Scripts

These scripts are written in pure SQL, augmented with directives specified in specially formatted comments. The are run with either "tbutil sql" or "tbsql".

### all-vm-memory-stats.sql

(Classic only - does not work with XL).

Shows the VMem usage of all VMs over the specified number of days (which must be less that or equal to the number of days worth of day data stored in MySQL).

Run using: `tbutil sql all-vm-memory-stats.sql {number-of-days}`

### all-vm-memory-utilization.sql

(Classic only - does not work with XL).

Lists the %age memory utilization for all known VMs over a specified number of days past.

If the number of days of stats available in the vm_stats_by_day table is less than "number_of_days" then the returned information is limited to the available number. The "N.Days" column shows how many days were actually considered.

Note that the stats used start from yesterday because the vm_stats_by_day contains incomplete (or no) stats for the current day.

Run using: `tbutil sql all-vm-memory-utilization-sql {number-of-days}`

### count-known-days.sql

(Classic only - does not work with XL).

Counts the number of days worth of data stored for a specified VM over the specified time period (in days back from today).

Run using: `tbutil sql count-known-days.sql {vm_uuid} {n_days}`

### getDesiredState.sql

(Classic only - does not work with XL).

### getPersistenceConfig.sql

(Classic only - does not work with XL).

### powered-off-vms.sql

(Classic only - does not work with XL).

Reports the VMs that are powered down, the cluster they are on, the amount of storage space associated with them and the number of days for which they have been down.

DISCLAIMER: Take care when using this tool, and double check that the VMs listed are genuinely powered off. Issues such as the inability to collect live memory and cpu stats can give the same results. So treat this as a tool that provides a list to use as the starting point of further investigation.

Run using: `tbutil sql powered-off-vms.sql`

### socket-count.sql

(Classic only - does not work with XL).

Reports the number of sockets per known host. This SQL has been exported from the `weekly_socket_audit_report` report using "tbutil export report query" and modified to print a subset of the available columns.

It is equivalent to running the command:

```
tbutil execute report query -columns 1,3 weekly_socket_audit_report socket_count_per_pm
```

Run using: `tbutil sql socket-count.sql`

### unused-storage-by-datastore.sql

(Classic only - does not work with XL).

Prints the number of MB that was free on all known data stores yesterday.

Run using: `tbutil sql unused-storage-by-datastore.sql`

### user-logins.sql

(Classic only - does not work with XL).

Prints the user login summary for the last 90 days. If shows the user names and their first and last login times from 90 days ago until today.

Run using: `tbutil sql user-logins.sql`

### vm-memory-stats.sql

(Classic only - does not work with XL).

Shows the VMem usage of VMs in a specified group over the specified number of days (which must be less that or equal to the number of days worth of day data stored in MySQL).

Run using: `tbutil sql vm-memory-stats.sql {group_name} {number-of-days}`

### wasted-storage-by-datastore.sql

(Classic only - does not work with XL).

Taken from the "daily_digest_storage_top_unused_grid" report template.

It lists the wasted space (and number of files) per data store.

Run using: `tbutil sql wasted-storage-by-datastore.sql`

### wasted-storage-files.sql

(Classic only - does not work with XL).

Taken from the "daily_digest_storage_top_unused_grid" report template.

It lists the files flagged as "wasted" by Turbonomic.

Run using: `tbutil sql wasted-storage-files.sql`



## SSH and File Parser Scripts

The scripts load and parse data from XML or other files located on the local (or instance) hard drive. They are wriitten in JS and typically use the "client.ssh" mechanism to access remote files over a private SSH connection.

### audit.js

### print-default-group-tree.js


## Shell scripts

### cook.js

See the separate "COOK.md" or "COOK.pdf" document.

### health-check.sh

(Classic only - does not work with XL).

This script is a wrapper that collects a variety of health check information into a named directory. The usage is..

Usage is:

   bash examples/health-check.sh [{creds}] [-{options}] {output-directory}

Valid options (joined into one word starting with a '-') are:

   c: include VCPUs per CPU report
   d: include list of powered-down VMs and associate storage size
   h: include cluster headroom report
   q: include top ready-queue VMs report
   v: include VCPUs per VM report
   A: all the above

```

An example output directory contains the following files..

- audit.txt
- automated-actions.txt
- automation-stats.txt
- cluster-headroom.js
- desired-state.json
- disabled-actions.txt
- license.json
- manual-actions.txt
- persistence-config.json
- placement-policies.txt
- recommended-actions.txt
- supplychain.txt
- targets.txt
- top-ready-queue-vms.txt
- vcpus-per-cpu.js
- vcpus-per-vm.txt
- version.txt


### start-arango-container.sh

Starts a temporary instance of the ArangoDB service in a docker container for use by the `actions-to-arangodb.js` script.
